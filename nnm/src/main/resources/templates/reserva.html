<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
  <meta charset="UTF-8">
  <title th:text="'Detalle de ' + ${inmueble.titulo}">Detalle del Inmueble</title>

  <link rel="stylesheet" th:href="@{/css/navbar.css}">
  <link rel="stylesheet" th:href="@{/css/reservar.css}">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar">
    <a th:href="@{/home}" class="logo-link">
      <img th:src="@{/images/logo.png}" alt="Logo" class="logo-img">
    </a>
    <div class="navbar-right">
      <a th:href="@{/lista-deseos}" class="btn-deseos">Lista de deseos</a>
      <div class="dropdown">
        <button class="btn-circular">☰</button>
        <div class="dropdown-content">
          <a th:href="@{/datos-personales}">Datos personales</a>
          <a th:href="@{/logout}">Cerrar sesión</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="main-content">
    <section class="contenedor-detalle">
      <!-- INFO DEL INMUEBLE -->
      <div class="info-inmueble">
        <div class="box">
          <h1 th:text="${inmueble.titulo}">Título del inmueble</h1>
        </div>

        <div class="box foto-inmueble">
          <img th:if="${inmueble.foto != null}" th:src="@{/inmuebles/{id}/foto(id=${inmueble.id})}" alt="Foto del inmueble">
          <div th:if="${inmueble.foto == null}" class="placeholder">Sin imagen</div>
        </div>

        <div class="box">
          <p><strong>Ubicación:</strong> <span th:text="${inmueble.localidad}"></span>, <span th:text="${inmueble.provincia}"></span></p>
          <p><strong>Dirección:</strong> <span th:text="${inmueble.direccion}"></span></p>
          <p><strong>Habitaciones:</strong> <span th:text="${inmueble.habitaciones}"></span></p>
          <p><strong>Baños:</strong> <span th:text="${inmueble.numero_banos}"></span></p>
          <p class="precio"><strong>Precio:</strong> <span th:text="${inmueble.precio_noche}"></span> €/noche</p>
        </div>
      </div>

      <!-- PANEL DE RESERVA -->
      <div class="reserva-box">
        <h3>Selecciona tus fechas</h3>

        <form th:action="@{/reserva/crearReserva}" method="post">
          <input type="hidden" name="idInmueble" th:value="${inmueble.id}">

          <div class="campo-fecha">
            <label>Fechas</label>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
              <input type="text" id="inputLlegada" name="fechaInicio" placeholder="Llegada" readonly>
              <input type="text" id="inputSalida" name="fechaFin" placeholder="Salida" readonly>
            </div>

            <div id="calendarioRango" class="calendario">
              <div class="calendario-header">
                <button type="button" id="btnPrev">‹</button>
                <span id="tituloMeses"></span>
                <button type="button" id="btnNext">›</button>
              </div>
              <div id="contenedorMeses"></div>
            </div>
          </div>

          <button type="submit" class="btn-reservar-lateral">Reservar</button>
        </form>
      </div>
    </section>
  </main>

  <script>
    let fechaInicio = null;
    let fechaFin = null;
    let mesActual = new Date().getMonth();
    let anoActual = new Date().getFullYear();

    const nombresMeses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

    const inputLlegada = document.getElementById('inputLlegada');
    const inputSalida = document.getElementById('inputSalida');
    const calendario = document.getElementById('calendarioRango');

    // Mostrar calendario al hacer clic
    inputLlegada.addEventListener('click', () => {
      calendario.style.display = calendario.style.display === 'block' ? 'none' : 'block';
      renderCalendarios();
    });
    inputSalida.addEventListener('click', () => {
      calendario.style.display = calendario.style.display === 'block' ? 'none' : 'block';
      renderCalendarios();
    });

    // Cerrar calendario al hacer clic fuera
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.calendario') && !e.target.closest('#inputLlegada') && !e.target.closest('#inputSalida')) {
        calendario.style.display = 'none';
      }
    });

    // Renderizar meses
    function renderCalendarios() {
      const contenedor = document.getElementById('contenedorMeses');
      contenedor.innerHTML = '';

      const mesSiguiente = (mesActual + 1) % 12;
      const anoSiguiente = mesActual === 11 ? anoActual + 1 : anoActual;

      contenedor.appendChild(crearCalendario(anoActual, mesActual));
      contenedor.appendChild(crearCalendario(anoSiguiente, mesSiguiente));

      document.getElementById('tituloMeses').textContent =
        `${nombresMeses[mesActual]} ${anoActual} – ${nombresMeses[mesSiguiente]} ${anoSiguiente}`;
      actualizarVisuales();
    }

    function crearCalendario(ano, mes) {
      const tabla = document.createElement('table');
      const diasSemana = ["L", "M", "X", "J", "V", "S", "D"];
      let html = `<thead><tr>${diasSemana.map(d => `<th>${d}</th>`).join('')}</tr></thead><tbody><tr>`;

      const primerDia = new Date(ano, mes, 1);
      const offset = (primerDia.getDay() + 6) % 7;
      for (let i = 0; i < offset; i++) html += '<td></td>';

      let fecha = new Date(ano, mes, 1);
      while (fecha.getMonth() === mes) {
        const dia = fecha.getDate();
        const id = `d-${ano}-${mes}-${dia}`;
        html += `<td id="${id}" onclick="seleccionarDia(${ano}, ${mes}, ${dia})">${dia}</td>`;
        if (fecha.getDay() === 0) html += '</tr><tr>';
        fecha.setDate(dia + 1);
      }

      html += '</tr></tbody>';
      tabla.innerHTML = html;
      return tabla;
    }

    function seleccionarDia(ano, mes, dia) {
      const seleccion = new Date(ano, mes, dia);

      if (!fechaInicio || (fechaInicio && fechaFin)) {
        fechaInicio = seleccion;
        fechaFin = null;
      } else if (seleccion < fechaInicio) {
        fechaFin = fechaInicio;
        fechaInicio = seleccion;
      } else {
        fechaFin = seleccion;
      }

      actualizarVisuales();

      if (fechaInicio && fechaFin) {
        inputLlegada.value = formatearFecha(fechaInicio);
        inputSalida.value = formatearFecha(fechaFin);
        calendario.style.display = 'none';
      }
    }

    function formatearFecha(fecha) {
      const yyyy = fecha.getFullYear();
      const mm = String(fecha.getMonth() + 1).padStart(2, '0');
      const dd = String(fecha.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function actualizarVisuales() {
      document.querySelectorAll('.calendario td').forEach(td => td.classList.remove('dia-seleccionado', 'rango'));

      if (!fechaInicio) return;

      if (!fechaFin) {
        const id = `d-${fechaInicio.getFullYear()}-${fechaInicio.getMonth()}-${fechaInicio.getDate()}`;
        const td = document.getElementById(id);
        if (td) td.classList.add('dia-seleccionado');
      } else {
        let current = new Date(fechaInicio);
        while (current <= fechaFin) {
          const id = `d-${current.getFullYear()}-${current.getMonth()}-${current.getDate()}`;
          const td = document.getElementById(id);
          if (td) {
            if (current.getTime() === fechaInicio.getTime() || current.getTime() === fechaFin.getTime())
              td.classList.add('dia-seleccionado');
            else td.classList.add('rango');
          }
          current.setDate(current.getDate() + 1);
        }
      }
    }

    document.getElementById('btnPrev').addEventListener('click', () => {
      mesActual--;
      if (mesActual < 0) { mesActual = 11; anoActual--; }
      renderCalendarios();
    });

    document.getElementById('btnNext').addEventListener('click', () => {
      mesActual++;
      if (mesActual > 11) { mesActual = 0; anoActual++; }
      renderCalendarios();
    });

    renderCalendarios();
  </script>
</body>
</html>