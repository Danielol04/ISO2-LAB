<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" th:href="@{/css/navbar.css}">
  <link rel="stylesheet" th:href="@{/css/disponibilidad.css}">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crear Disponibilidad</title>
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar">
    <a th:href="@{/home}" class="logo-link">
      <img th:src="@{/images/logo.png}" alt="Logo" class="logo-img">
    </a>
    <div class="navbar-right">
      <a th:href="@{/solicitudes/confirmacionReserva/{username}(username=${username})}" class="btn-deseos">Solicitudes</a>
      <a th:href="@{/inmuebles/alta}" class="btn-deseos">Registrar Inmuebles</a>
      <div class="dropdown">
        <button class="btn-circular">☰</button>
        <div class="dropdown-content">
          <a th:href="@{/datos-personales}">Datos personales</a>
          <a th:href="@{/logout}">Cerrar sesión</a>
        </div>
      </div>
    </div>
  </nav>
  <div class="container">
    <h1>Crear Disponibilidad</h1>

    <!-- CALENDARIO -->
    <div class="calendario-wrapper">
      <button id="btnPrev" class="btn-nav">‹</button>
      <div id="contenedorMeses" class="calendario"></div>
      <button id="btnNext" class="btn-nav">›</button>
    </div>

    <hr>

    <!-- DETALLES NUEVA DISPONIBILIDAD -->
    <div class="section">
      <h2>Detalles de la nueva disponibilidad</h2>
      <form id="formCrear" class="form-inline" th:action="@{'/disponibilidades/crear/' + ${idInmueble}}"
        th:object="${disponibilidad}" method="post">
        <div class="checkbox-line">
          <input type="checkbox" name="reservaDirecta" id="direct-booking">
          <label for="direct-booking">Reserva directa</label>
        </div>

        <select id="cancellation-policy" name="politicaCancelacion" required>
          <option th:each="p : ${politicas}" th:value="${p}" th:text="${p}"></option>
        </select>

        <input type="hidden" id="inputLlegada" name="fechaInicio">
        <input type="hidden" id="inputSalida" name="fechaFin">

        <button type="submit">Crear Disponibilidad</button>
      </form>
    </div>

    <hr>
    <!-- DISPONIBILIDADES CREADAS -->
    <div class="section">
      <h2>Disponibilidades creadas</h2>
      <div th:each="d : ${disponibilidades}" class="disponibilidad-item">
        <div>
          <span
            th:text="${#temporals.format(d.fechaInicio, 'd ''de'' MMMM, yyyy')} + ' - ' + ${#temporals.format(d.fechaFin, 'd ''de'' MMMM, yyyy')}"></span>
          <span th:text="'Política de cancelación: ' + ${d.politicaCancelacion}"></span>
          <span th:text="${d.reservaDirecta} ? 'Reserva directa' : 'Solicitud previa'"></span>
        </div>
        <button class="eliminar" title="Eliminar" th:onclick="'confirmarEliminacion(' + ${d.id} + ')'">
          &#128465;</button>
      </div>
    </div>
  </div>

  <!-- BACKEND VAR -->
  <script th:inline="javascript">
    const fechasDisponibles = /*[[${fechasDisponibles}]]*/[];
    const fechasReservadas = /*[[${fechasReservadas}]]*/[];
  </script>

  <!-- LOGICA CALENDARIO -->
  <script th:src="@{/js/calendarioDisponibilidades.js}"></script>

  <!-- JS ELIMINAR DISPONIBILIDAD -->
  <div id="popupEliminar" class="popup-overlay" style="display:none;">
    <div class="popup">
      <p>¿Está seguro de que quiere borrar esta disponibilidad?</p>
      <div class="popup-buttons">
        <button onclick="cerrarPopup()">No</button>
        <form id="formEliminar" method="post">
          <button type="submit">Sí</button>
        </form>
      </div>
    </div>
  </div>
  <!-- JS POPUP ELIMINAR DISPONIBILIDAD -->
  <script>
    let idAEliminar = null;
    function confirmarEliminacion(id) {
      idAEliminar = id;
      document.getElementById("formEliminar").action = "/disponibilidades/eliminar/" + id;
      document.getElementById("popupEliminar").style.display = "flex";
    }
    function cerrarPopup() {
      document.getElementById("popupEliminar").style.display = "none";
      idAEliminar = null;
    }
  </script>

  <!-- POPUP ERROR -->
  <div id="popupError" class="popup-overlay" style="display:none;">
    <div class="popup popup-error">
      <p id="mensajeError"></p>
    </div>
  </div>

  <script>
    function mostrarPopupError(mensaje) {
      const popup = document.getElementById("popupError");
      document.getElementById("mensajeError").textContent = mensaje;

      popup.style.display = "flex";

      setTimeout(() => {
        popup.style.display = "none";
      }, 1000);
    }
  </script>

  <!-- VALIDACIÓN FINAL -->
  <script>
    document.getElementById("formCrear").addEventListener("submit", function (event) {
      const inicio = document.getElementById("inputLlegada").value;
      const fin = document.getElementById("inputSalida").value;

      if (!inicio || !fin) {
        event.preventDefault();
        mostrarPopupError("Debes seleccionar la fecha de inicio y la fecha de fin.");
      }
    });
  </script>
</body>
</html>