<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" th:href="@{/css/navbar.css}">
  <link rel="stylesheet" th:href="@{/css/disponibilidad.css}">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crear Disponibilidad</title>
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar">
    <a th:href="@{/home}" class="logo-link">
      <img th:src="@{/images/logo.png}" alt="Logo" class="logo-img">
    </a>
    <div class="navbar-right">
      <a th:href="@{/solicitudes/confirmacionReserva/{username}(username=${username})}" class="btn-deseos">Solicitudes</a>
      <a th:href="@{/inmuebles/alta}" class="btn-deseos">Registrar Inmuebles</a>
      <div class="dropdown">
        <button class="btn-circular">☰</button>
        <div class="dropdown-content">
          <a th:href="@{/datos-personales}">Datos personales</a>
          <a th:href="@{/logout}">Cerrar sesión</a>
        </div>
      </div>
    </div>
  </nav>
  <div class="container">
    <h1>Crear Disponibilidad</h1>

    <!-- CALENDARIO -->
    <div class="calendario-wrapper">
      <button id="btnPrev" class="btn-nav">‹</button>
      <div id="contenedorMeses" class="calendario"></div>
      <button id="btnNext" class="btn-nav">›</button>
    </div>

    <hr>

    <!-- DETALLES NUEVA DISPONIBILIDAD -->
    <div class="section">
      <h2>Detalles de la nueva disponibilidad</h2>
      <form id="formCrear" class="form-inline" th:action="@{'/disponibilidades/crear/' + ${idInmueble}}"
        th:object="${disponibilidad}" method="post">
        <div class="checkbox-line">
          <input type="checkbox" name="reservaDirecta" id="direct-booking">
          <label for="direct-booking">Reserva directa</label>
        </div>

        <select id="cancellation-policy" name="politicaCancelacion" required>
          <option th:each="p : ${politicas}" th:value="${p}" th:text="${p}"></option>
        </select>

        <input type="hidden" id="inputLlegada" name="fechaInicio">
        <input type="hidden" id="inputSalida" name="fechaFin">

        <button type="submit">Crear Disponibilidad</button>
      </form>
    </div>

    <hr>
    <!-- DISPONIBILIDADES CREADAS -->
    <div class="section">
      <h2>Disponibilidades creadas</h2>
      <div th:each="d : ${disponibilidades}" class="disponibilidad-item">
        <div>
          <span
            th:text="${#temporals.format(d.fechaInicio, 'd ''de'' MMMM, yyyy')} + ' - ' + ${#temporals.format(d.fechaFin, 'd ''de'' MMMM, yyyy')}"></span>
          <span th:text="'Política de cancelación: ' + ${d.politicaCancelacion}"></span>
          <span th:text="${d.reservaDirecta} ? 'Reserva directa' : 'Solicitud previa'"></span>
        </div>
        <button class="eliminar" title="Eliminar" th:onclick="'confirmarEliminacion(' + ${d.id} + ')'">
          &#128465;</button>
      </div>
    </div>
  </div>

  <!-- BACKEND VAR -->
  <script th:inline="javascript">
    const fechasDisponibles = /*[[${fechasDisponibles}]]*/[];
    const fechasReservadas = /*[[${fechasReservadas}]]*/[];
  </script>

  <!-- JS CALENDARIO -->
  <script>
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);
    let fechaInicio = null, fechaFin = null;
    let mesActual = new Date().getMonth();
    let anoActual = new Date().getFullYear();
    const nombresMeses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    function renderCalendarios() {
      const contenedor = document.getElementById('contenedorMeses');
      contenedor.innerHTML = '';
      const mesSig = (mesActual + 1) % 12;
      const anoSig = mesActual === 11 ? anoActual + 1 : anoActual;
      contenedor.appendChild(crearCalendario(anoActual, mesActual));
      contenedor.appendChild(crearCalendario(anoSig, mesSig));
      actualizarVisuales();
    }

    function crearCalendario(ano, mes) {
      const div = document.createElement('div');
      div.classList.add('mes');
      const titulo = document.createElement('h3');
      titulo.textContent = `${nombresMeses[mes]} ${ano}`;
      div.appendChild(titulo);
      const tabla = document.createElement('table');
      const diasSemana = ["L", "M", "X", "J", "V", "S", "D"];
      let html = `<thead><tr>${diasSemana.map(d => `<th>${d}</th>`).join('')}</tr></thead><tbody><tr>`;
      const primerDia = new Date(ano, mes, 1);
      const offset = (primerDia.getDay() + 6) % 7;
      for (let i = 0; i < offset; i++) html += '<td></td>';
      let fecha = new Date(ano, mes, 1);
      while (fecha.getMonth() === mes) {
        const dia = fecha.getDate();
        const fechaCelda = new Date(ano, mes, dia);
        fechaCelda.setHours(0, 0, 0, 0);
        const str = `${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
        const disponible = !fechasDisponibles.includes(str);
        const reservado = fechasReservadas.includes(str);
        const esPasado = fechaCelda < hoy;
        if(reservado) {
          html += `<td class='dia-reservado'>${dia}</td>`;
        } else if (!esPasado && disponible) {
          html += `<td onclick="seleccionarDia(${ano},${mes},${dia},this)">${dia}</td>`;
        } else {
          html += `<td class='dia-no-disponible'>${dia}</td>`;
        }
        if (fecha.getDay() === 0) html += '</tr><tr>';
        fecha.setDate(dia + 1);
      }
      html += '</tr></tbody>';
      tabla.innerHTML = html;
      div.appendChild(tabla);
      return div;
    }

   
    function seleccionarDia(ano, mes, dia,celdaPulsada) {
      const seleccion = new Date(ano, mes, dia);
      seleccion.setHours(0, 0, 0, 0);

      if (!fechaInicio || fechaFin) {
        fechaInicio = seleccion;
        fechaFin = null;
      } else {
        if (seleccion < fechaInicio) {
          fechaFin = fechaInicio;
          fechaInicio = seleccion;
        } else {
          fechaFin = seleccion;
        }
      
        let iterador= new Date(fechaInicio);
        let hayConflicto= false;

        while(iterador<=fechaFin){
          if(fechasDisponibles.includes(formatear(iterador))){
            hayConflicto= true;
            break;
          }
          iterador.setDate(iterador.getDate() + 1);
        }
        if(hayConflicto){
          animarError(celdaPulsada);
          fechaFin= null;
        }
      }
      actualizarVisuales();

      document.getElementById('inputLlegada').value = fechaInicio ? formatear(fechaInicio) : '';
      document.getElementById('inputSalida').value = fechaFin ? formatear(fechaFin) : '';
    }

    function animarError(celdaPulsada) {
    if (!celdaPulsada) return;
    
    celdaPulsada.classList.add('error-visual');

    setTimeout(() => {celdaPulsada.classList.remove('error-visual');}, 500);
    }

    function formatear(f) {
      return `${f.getFullYear()}-${String(f.getMonth() + 1).padStart(2, '0')}-${String(f.getDate()).padStart(2, '0')}`;
    }

    function actualizarVisuales() {
      const celdas = document.querySelectorAll('.calendario td');
      celdas.forEach(td => td.classList.remove('dia-seleccionado', 'rango'));

      if (!fechaInicio) return;

      const tds = document.querySelectorAll('.calendario td:not(.dia-no-disponible)');
      tds.forEach(td => {
        const dia = parseInt(td.textContent);
        if (isNaN(dia)) return;

        const tituloMes = td.closest('.mes').querySelector('h3').textContent.split(' ');
        const mesNombre = tituloMes[0];
        const ano = parseInt(tituloMes[1]);
        const mesIndex = nombresMeses.indexOf(mesNombre);
        const fechaCelda = new Date(ano, mesIndex, dia);
        fechaCelda.setHours(0, 0, 0, 0);

        if (fechaFin) {
          if (fechaCelda >= fechaInicio && fechaCelda <= fechaFin) {
            if (fechaCelda.getTime() === fechaInicio.getTime() || fechaCelda.getTime() === fechaFin.getTime()) {
              td.classList.add('dia-seleccionado');
            } else {
              td.classList.add('rango');
            }
          }
        } else if (fechaCelda.getTime() === fechaInicio.getTime()) {
          td.classList.add('dia-seleccionado');
        }
      });
    }

    document.getElementById('btnPrev').onclick = () => {
      mesActual--;
      if (mesActual < 0) { mesActual = 11; anoActual--; }
      renderCalendarios();
    };

    document.getElementById('btnNext').onclick = () => {
      mesActual++;
      if (mesActual > 11) { mesActual = 0; anoActual++; }
      renderCalendarios();
    };

    renderCalendarios();
  </script>
  <!-- JS ELIMINAR DISPONIBILIDAD -->
  <div id="popupEliminar" class="popup-overlay" style="display:none;">
    <div class="popup">
      <p>¿Está seguro de que quiere borrar esta disponibilidad?</p>
      <div class="popup-buttons">
        <button onclick="cerrarPopup()">No</button>
        <form id="formEliminar" method="post">
          <button type="submit">Sí</button>
        </form>
      </div>
    </div>
  </div>
  <!-- JS POPUP ELIMINAR DISPONIBILIDAD -->
  <script>
    let idAEliminar = null;
    function confirmarEliminacion(id) {
      idAEliminar = id;
      document.getElementById("formEliminar").action = "/disponibilidades/eliminar/" + id;
      document.getElementById("popupEliminar").style.display = "flex";
    }
    function cerrarPopup() {
      document.getElementById("popupEliminar").style.display = "none";
      idAEliminar = null;
    }
  </script>

  <!-- POPUP ERROR -->
  <div id="popupError" class="popup-overlay" style="display:none;">
    <div class="popup popup-error">
      <p id="mensajeError"></p>
    </div>
  </div>

  <script>
    function mostrarPopupError(mensaje) {
      const popup = document.getElementById("popupError");
      document.getElementById("mensajeError").textContent = mensaje;

      popup.style.display = "flex";

      setTimeout(() => {
        popup.style.display = "none";
      }, 3000);
    }
  </script>

  <!-- VALIDACIÓN FINAL -->
  <script>
    document.getElementById("formCrear").addEventListener("submit", function (event) {
      const inicio = document.getElementById("inputLlegada").value;
      const fin = document.getElementById("inputSalida").value;

      if (!inicio || !fin) {
        event.preventDefault();
        mostrarPopupError("Debes seleccionar la fecha de inicio y la fecha de fin.");
      }
    });
  </script>
</body>
</html>